# IMPORTANT NOTE: This was all generated by Cursor - I asked it to generate instructions to set up AuthO.

# Auth0 Action Setup Guide

## Quick Setup: Add Email to Access Token

Follow these steps to create a custom Login action that includes email in your access tokens.

### Step 1: Create a New Action

1. In Auth0 Dashboard, go to **Actions** → **Flows** → **Login**
2. Click **"+"** or **"Custom"** button (usually at the top right)
3. You'll see options - click **"Create Custom Action"** or **"Build Custom"**

### Step 2: Configure the Action

1. **Name your action**:

   - Give it a name like `Add Email to Token` or `Include Email Claim`

2. **Select trigger**:

   - Make sure it's set to trigger: **Login / Post Login**

3. **Add the code**:
   - Replace any default code with this:

```javascript
/**
 * Handler that will be called during the execution of a PostLogin flow.
 *
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onExecutePostLogin = async (event, api) => {
  // Check if user has email
  if (!event.user.email) {
    console.log("WARNING: User does not have an email address");
    return;
  }

  // Only modify tokens if the user is logging in to your API
  if (event.authorization) {
    // Add email to both ID token and access token
    // Using setCustomClaim for email (standard claim, but needs to be explicitly added)
    api.idToken.setCustomClaim("email", event.user.email);
    api.accessToken.setCustomClaim("email", event.user.email);

    console.log("Email added to tokens:", event.user.email);
  } else {
    console.log("No authorization context - tokens not modified");
  }
};
```

### Step 3: Save and Deploy

1. Click **"Deploy"** button (top right)
2. You'll be asked to confirm - click **"Deploy"** again

### Step 4: Add Action to Login Flow

1. After deploying, you should see the Login Flow page
2. You'll see a flow diagram showing your action
3. **Drag and drop** your new action into the flow, OR
4. Click **"+"** next to "Login" and select your action from the list
5. Make sure the action appears in the flow (usually between "Login" and "Complete")

### Step 5: Apply Changes

1. Click **"Apply"** button at the top right of the flow editor
2. Your action is now active!

## Alternative: If You Can't See "Custom" Option

If you don't see a "Create Custom" option, try:

1. **Actions** → **Library** (in the left sidebar)
2. Click **"+ Create"** button
3. Select **"Login / Post Login"** as the trigger
4. Name it: `Add Email to Token`
5. Paste the code above
6. Click **"Deploy"**
7. Then go back to **Actions** → **Flows** → **Login**
8. Click **"+"** and you should now see your action in the list
9. Add it to the flow and click **Apply**

## Testing

After setting this up:

1. **Log out** of your application completely
2. **Log back in** - this will generate a new token with email included
3. The backend should now extract email from the token without calling `/userinfo`
4. No more 429 rate limit errors!

## Troubleshooting

### Action not appearing in flow?

- Make sure you clicked "Deploy" after creating the action
- Refresh the page and try again
- Check that the trigger is set to "Login / Post Login"

### Email still not in token?

- Make sure the user has an email address in their Auth0 profile
- Check that the action is actually in the Login flow (visible in the flow diagram)
- Verify you clicked "Apply" after adding the action to the flow
- Try logging out and back in again to get a fresh token

### Still getting rate limit errors?

- Wait a few minutes for Auth0 rate limits to reset
- Make sure the action is deployed and applied
- Check backend logs to see if email is now being found in the token

## What This Does

This action ensures that every time a user logs in:

- The `email` claim is automatically added to both ID token and access token
- The backend can read email directly from the token
- No need to call `/userinfo` endpoint
- No more rate limiting issues!
