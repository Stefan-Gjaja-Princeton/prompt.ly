# IMPORTANT NOTE: This was generated by Cursor to print out information about the conversations table.
# Especially when I was first developing the application, I needed to see if changes were registering
# appropriately in the database.

#!/usr/bin/env python3

import sqlite3
import json
from datetime import datetime

def inspect_conversations(db_path="backend/promptly.db"):
    """Inspect the contents of the conversations table"""
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        print("=" * 60)
        print("CONVERSATIONS TABLE INSPECTION")
        print("=" * 60)
        print()
        
        # Get column names for conversations table
        cursor.execute("PRAGMA table_info(conversations)")
        conv_columns = [col[1] for col in cursor.fetchall()]
        print(f"Columns: {', '.join(conv_columns)}")
        print()
        
        # Inspect conversations table and print out all data about it
        print("CONVERSATIONS:")
        print("-" * 60)
        cursor.execute("SELECT * FROM conversations")
        conversations = cursor.fetchall()
        
        if conversations:
            print(f"Total conversations: {len(conversations)}")
            print()
            for idx, conv in enumerate(conversations):
                print(f"Conversation #{idx + 1}:")
                for i, col_name in enumerate(conv_columns):
                    value = conv[i]
                    
                    if col_name == "messages":
                        # Parse and display messages in detail
                        try:
                            messages = json.loads(value) if value else []
                            print(f"  {col_name}: {len(messages)} message(s)")
                            for j, msg in enumerate(messages):
                                role = msg.get('role', 'unknown')
                                content = msg.get('content', '')
                                timestamp = msg.get('timestamp', 'no timestamp')
                                print(f"    Message {j + 1} [{role}]: {content[:100]}{'...' if len(content) > 100 else ''}")
                                print(f"      Timestamp: {timestamp}")
                        except json.JSONDecodeError:
                            print(f"  {col_name}: (JSON decode error) {value[:200]}")
                        except Exception as e:
                            print(f"  {col_name}: (Error parsing) {value[:200]}")
                    
                    elif col_name == "message_scores":
                        # Parse and display message scores if available
                        if value:
                            try:
                                scores = json.loads(value) if isinstance(value, str) else value
                                if isinstance(scores, dict):
                                    print(f"  {col_name}: {len(scores)} score(s)")
                                    for msg_id, score in scores.items():
                                        print(f"    {msg_id}: {score}")
                                else:
                                    print(f"  {col_name}: {scores}")
                            except:
                                print(f"  {col_name}: {value}")
                        else:
                            print(f"  {col_name}: None")
                    
                    elif col_name == "current_feedback":
                        # Display feedback, possibly truncated
                        if value:
                            feedback = value[:200] + "..." if len(value) > 200 else value
                            print(f"  {col_name}: {feedback}")
                        else:
                            print(f"  {col_name}: None")
                    
                    elif col_name in ["created_at", "updated_at"]:
                        print(f"  {col_name}: {value}")
                    
                    else:
                        print(f"  {col_name}: {value}")
                
                print("-" * 60)
        else:
            print("No conversations found")
        
        conn.close()
        
    except sqlite3.Error as e:
        print(f"Database error: {e}")
    except FileNotFoundError:
        print(f"Database file not found: {db_path}")
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    inspect_conversations()

